# Feature: RBAC/ABAC hybrid authorization

This PR introduces the design and implementation plan for a hybrid RBAC/ABAC authorization system.

Summary

- Provide a hybrid authorization model: role-based permissions (RBAC) augmented with attribute-based checks (ABAC).
- Store roles and permissions (features) in the DB.
- Map Clerk features/claims into internal permissions where relevant.
- Each user will have a single internal role; role inheritance is supported.
- Add an admin dashboard scaffold to manage roles, permissions, role inheritance, and user role assignments.

Why

- We need flexible, auditable, and maintainable access controls across the app and admin UI.

High-level design / contract

- Data shapes
  - Role: { id, name, description, default: false }
  - Permission (Feature): { id, name, description }
  - RolePermission: maps Role <-> Permission
  - RoleInheritance: { parentRoleId, childRoleId }
  - UserProfile (custom user object): { id, clerkId, email, displayName, roleId, attributes: JSON }

- Evaluation
  - Effective permissions = union(role.permissions + inherited role.permissions)
  - ABAC policies: JSON or small DSL evaluated at runtime (example rule: allow if user.attributes.grade >= resource.minGrade)
  - Authorization flow: check effective permission -> if permission has attribute conditions then evaluate ABAC rules -> allow/deny

Integration with Clerk

- Keep Clerk as the auth provider. Store Clerk ID on UserProfile to link record.
- Treat Clerk "features" or claims as source-of-truth for external entitlements; provide a small sync routine to map Clerk features into Permission entries.

Admin Dashboard

- New admin pages under `/app/admin` (or `/app/users/admin`) to manage:
  - Roles and their permissions
  - Permission (Feature) catalogue (import from Clerk)
  - Role inheritance
  - Users and role assignment
  - Logs/audit panel for changes

Security

- Only admins can change roles/permissions. Guard admin routes with a server-side check (role-based + attribute checks if needed).

Acceptance criteria

- Roles and permission models are created and migrated.
- Ability to assign exactly one role to a user.
- Role inheritance works for permission aggregation.
- Clerk features can be imported/mapped to internal permissions.
- Admin dashboard scaffold exists and is route-protected.

Implementation TODOs (checklist)

- [ ] Design & spec finalized (this file)
- [ ] Create DB models/migrations for Role, Permission, RolePermission, RoleInheritance, UserProfile
- [ ] Implement backend services: role CRUD, permission CRUD, assignment endpoints
- [ ] Implement effective-permissions computation and caching strategy
- [ ] Implement ABAC policy evaluator (simple JSON-based rules) and document the rule format
- [ ] Add middleware/route guards for authorization checks (Next.js middleware or per-route guards)
- [ ] Add admin dashboard scaffold pages and components
- [ ] Implement Clerk -> Permission sync utility and import script
- [ ] Add unit tests for models and policy evaluation
- [ ] Add integration/e2e tests for admin flows
- [ ] Document how to migrate existing users and how to deploy the migration

Notes / Migration

- New DB tables required. Add migration with clear rollback.
- Existing users: create a script to bootstrap a default role for existing users (e.g., 'user').

How to review

- Review this PR for design and checklist completeness. Subsequent PRs will implement the DB schema, backend APIs, and admin UI incrementally.

Related todos (from workspace task list)

- See the todos in the repo task manager for step-by-step progress tracking.

--
Generated by automation: feature/rbac-abac-hybrid
